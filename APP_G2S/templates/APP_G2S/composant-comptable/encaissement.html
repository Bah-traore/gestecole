{% extends 'base_admin.html' %}
{% load widget_tweaks %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-lg border-0 encaissement-card">
    <div class="card-header bg-success text-white d-flex align-items-center justify-content-between">
      <h4 class="mb-0"><i class="bi bi-cash-stack me-2"></i>Enregistrement de paiement en espèces</h4>
      <a href="{% url 'caisse_dashboard' %}" class="btn btn-outline-light btn-sm">
        <i class="bi bi-arrow-left"></i> Retour
      </a>
    </div>
    <div class="card-body">
      <form method="post" id="paymentForm" autocomplete="off">
        {% csrf_token %}
        <div class="row g-4">
          <div class="col-md-6">
            <label class="form-label fw-semibold" for="id_classe">
              <i class="bi bi-mortarboard-fill me-1"></i>Classe
            </label>
            <div class="custom-select-wrapper position-relative">
              <i class="bi bi-chevron-down select-caret"></i>
              <select id="id_classe" class="form-select form-select-lg custom-dark-select">
                <option value="">Toutes les classes</option>
                {% for classe in classes %}
                <option value="{{ classe.id }}">{{ classe.nom }} - {{ classe.niveau }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold" for="id_eleve">
              <i class="bi bi-person-fill me-1"></i>{{ form.eleve.label }}
            </label>
            <div class="custom-select-wrapper position-relative">
              <i class="bi bi-chevron-down select-caret"></i>
              <select name="eleve" id="id_eleve" class="form-select form-select-lg custom-dark-select" required>
                <option value="">---------</option>
                {% for eleve in form.fields.eleve.queryset %}
                <option value="{{ eleve.id }}" data-classe="{{ eleve.classe.id|default:'' }}">{{ eleve }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold" for="id_periode">
              <i class="bi bi-calendar2-week me-1"></i>{{ form.periode.label }}
            </label>
            <div class="custom-select-wrapper position-relative">
              <i class="bi bi-chevron-down select-caret"></i>
              {{ form.periode|add_class:"form-select form-select-lg custom-dark-select" }}
            </div>
          </div>
          <div class="col-md-6">
              <label class="form-label fw-semibold" for="id_tranche">
                  <i class="bi bi-cash-coin me-1"></i>Tranche concernée
              </label>
              <p class="form-control-plaintext" id="tranche-info">
                  Sélectionnez une période pour voir les détails de la tranche
              </p>
          </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-semibold" for="id_montant_paye">{{ form.montant_paye.label }}</label>
            <div class="input-group input-group-lg">
              {{ form.montant_paye|add_class:"form-control" }}
              <span class="input-group-text bg-dark text-white">XOF</span>
            </div>
          </div>
        </div>
        <div class="mt-5 text-end">
          <button type="submit" class="btn btn-success btn-lg px-5 shadow caisse-validate-btn">
            <i class="bi bi-check-circle me-2"></i>Valider le paiement
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmationModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content encaissement-modal">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title"><i class="bi bi-shield-check me-2"></i>Confirmation de paiement</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <p>Montant à encaisser : <span id="modalAmount" class="fw-bold"></span> XOF</p>
        <p>Élève : <span id="modalEleve" class="fw-bold"></span></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
        <button type="button" class="btn btn-success" onclick="document.getElementById('paymentForm').submit()">
          <i class="bi bi-check2-circle me-1"></i>Confirmer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN (si pas déjà inclus dans base_admin.html) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

<style>
  body, .container {
    background-color: #181a1b !important;
    color: #e0e0e0 !important;
  }
  .encaissement-card {
    background: #23272b;
    color: #e0e0e0;
    border-radius: 1rem;
  }
  .encaissement-card .card-header {
    border-radius: 1rem 1rem 0 0;
    font-size: 1.2rem;
    font-weight: 600;
    border-bottom: 1px solid #198754;
  }
  .form-label {
    color: #e0e0e0;
  }
  .custom-select-wrapper {
    position: relative;
  }
  .custom-dark-select {
    background: #23272b !important;
    color: #e0e0e0 !important;
    border: 1.5px solid #495057 !important;
    border-radius: 0.7rem !important;
    padding-right: 2.5rem !important;
    box-shadow: none !important;
    appearance: none !important;
    transition: border-color 0.2s;
  }
  .custom-dark-select:focus {
    border-color: #198754 !important;
    box-shadow: 0 0 0 0.2rem rgba(25,135,84,.25) !important;
    background: #23272b !important;
    color: #fff !important;
  }
  .select-caret {
    position: absolute;
    right: 1.2rem;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    color: #b0b0b0;
    font-size: 1.2rem;
    z-index: 2;
  }
  .form-select, .form-control {
    background: #23272b;
    color: #e0e0e0;
    border: 1px solid #495057;
    border-radius: 0.5rem;
  }
  .form-select:focus, .form-control:focus {
    background: #23272b;
    color: #fff;
    border-color: #198754;
    box-shadow: 0 0 0 0.2rem rgba(25,135,84,.25);
  }
  .input-group-text {
    background: #343a40 !important;
    color: #e0e0e0 !important;
    border: 1px solid #495057;
    border-radius: 0 0.5rem 0.5rem 0;
  }
  .caisse-validate-btn {
    font-size: 1.1rem;
    border-radius: 2rem;
    font-weight: 600;
    box-shadow: 0 2px 8px rgba(25,135,84,0.15);
    transition: background 0.2s, color 0.2s;
  }
  .caisse-validate-btn:hover, .caisse-validate-btn:focus {
    background: #218838 !important;
    color: #fff !important;
  }
  .encaissement-modal {
    background: #23272b;
    color: #e0e0e0;
    border-radius: 1rem;
  }
  .modal-header.bg-success {
    border-radius: 1rem 1rem 0 0;
  }
  .btn-close-white {
    filter: invert(1);
  }
</style>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {


    // Filtrer les élèves par classe
    $('#id_classe').change(function() {
        const classeId = $(this).val();
        const eleveSelect = $('#id_eleve');

        // Sauvegarder l'élève sélectionné actuellement (si possible)
        const currentEleve = eleveSelect.val();

        // Cacher tous les élèves
        eleveSelect.find('option').each(function() {
            $(this).show();
        });

        if (classeId) {
            // Cacher les élèves qui ne sont pas dans la classe sélectionnée
            eleveSelect.find('option').each(function() {
                const option = $(this);
                const optionData = option.data('classe');

                // Si l'option a un attribut data-classe et qu'il ne correspond pas à la classe sélectionnée
                if (optionData && optionData != classeId) {
                    option.hide();
                }
            });

            // Sélectionner le premier élève visible si l'élève actuel n'est plus visible
            if (eleveSelect.find('option:selected').is(':hidden')) {
                eleveSelect.find('option:visible:first').prop('selected', true);
            }
        }
    });

    // Mise à jour dynamique des tranches
    $('#id_periode').change(function() {
        const periodeId = $(this).val();
        $.ajax({
            url: '{% url "get_tranche_info" %}',
            data: {
                'periode_id': periodeId,
                'eleve_id': eleveId
            },
            success: function(data) {
                $('#id_tranche').html(d`
                        Prochaine tranche : ${data.tranche_num}<br>
                        Montant dû : ${data.montant_restant} XOF
                    `);
            }
        });
    });

    // Pré-confirmation
    $('#paymentForm').submit(function(e) {
        e.preventDefault();
        $('#modalAmount').text($('#id_montant_paye').val());
        // Correction du nom du champ élève (id_eleve)
        $('#modalEleve').text($('#id_eleve option:selected').text());
        $('#confirmationModal').modal('show');
    });
});
</script>
{% endblock %}
{% endblock %}
