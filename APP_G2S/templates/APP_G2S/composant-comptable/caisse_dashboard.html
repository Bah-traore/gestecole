{% extends "base_admin.html" %}

{% block content %}
<div class="container mt-4">
  <!-- Statistiques avancées -->
  <div class="row g-4 mb-4">
    <div class="col-md-8">
      <div class="card h-100 shadow border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="fw-bold mb-0 text-success">Statistiques mensuelles</h5>
        </div>
        <div class="card-body">
          <canvas id="monthlyStatsChart" height="120"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card h-100 shadow border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="fw-bold mb-0 text-primary">Répartition des paiements</h5>
        </div>
        <div class="card-body">
          <canvas id="paymentDistributionChart" height="180"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistiques -->
  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card card-stats bg-gradient-primary text-white h-100 shadow">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-bar-chart-line-fill fs-2 me-3"></i>
            <div>
              <h5 class="mb-0">Total du jour</h5>
              <h3 class="mb-0">{{ stats_jour.total|default:"0" }} FCFA</h3>
              <small class="text-white-50">Paiements : {{ stats_jour.count|default:"0" }}</small>
            </div>
          </div>
          <canvas id="chartJour" height="60"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-stats bg-gradient-success text-white h-100 shadow">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-calendar-week fs-2 me-3"></i>
            <div>
              <h5 class="mb-0">Total semaine</h5>
              <h3 class="mb-0">{{ stats_semaine.total|default:"0" }} FCFA</h3>
              <small class="text-white-50">Paiements : {{ stats_semaine.count|default:"0" }}</small>
            </div>
          </div>
          <canvas id="chartSemaine" height="60"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card card-stats bg-gradient-warning text-white h-100 shadow">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <i class="bi bi-calendar-month fs-2 me-3"></i>
            <div>
              <h5 class="mb-0">Total mois</h5>
              <h3 class="mb-0">{{ stats_mois.total|default:"0" }} FCFA</h3>
              <small class="text-white-50">Paiements : {{ stats_mois.count|default:"0" }}</small>
            </div>
          </div>
          <canvas id="chartMois" height="60"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex align-items-center mb-3">
    <i class="bi bi-cash-coin fs-2 text-success me-2"></i>
    <h2 class="mb-0">Tableau de bord caisse</h2>
  </div>

  <!-- Rafraîchissement automatique des paiements -->
  <div class="card shadow-sm mt-3 border-0 caisse-card">
    <div class="card-header d-flex justify-content-between align-items-center caisse-header">
      <span>
        <i class="bi bi-calendar-event me-2"></i>
        Paiements du jour ({{ paiements_jour.count }})
      </span>
      <a href="{% url 'encaissement' %}" class="btn btn-lg btn-success d-flex align-items-center shadow-sm caisse-btn">
        <i class="bi bi-plus-circle me-2 fs-5"></i>
        <span>Encaisser un paiement</span>
      </a>
    </div>
    <div class="list-group list-group-flush caisse-list">
      {% for paiement in paiements_jour %}
        <div class="list-group-item py-3 caisse-list-item">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <strong class="text-dark dark-text"><i class="bi bi-person-circle me-1"></i>{{ paiement.etudiant }}</strong><br>
              <span class="text-muted dark-muted">{{ paiement.montant_paye|floatformat:0 }} FCFA</span>
              <span class="badge bg-secondary ms-2">{{ paiement.get_mode_paiement_display }}</span>
            </div>
            <div class="text-end">
              {% if paiement.get_statut_paiement_display == "Validé" %}
                <span class="badge bg-success px-3 py-2"><i class="bi bi-check-circle me-1"></i>{{ paiement.get_statut_paiement_display }}</span>
              {% elif paiement.get_statut_paiement_display == "En attente" %}
                <span class="badge bg-warning text-dark px-3 py-2"><i class="bi bi-hourglass-split me-1"></i>{{ paiement.get_statut_paiement_display }}</span>
              {% else %}
                <span class="badge bg-danger px-3 py-2"><i class="bi bi-x-circle me-1"></i>{{ paiement.get_statut_paiement_display }}</span>
              {% endif %}
              <br>
              <small class="text-muted dark-muted"><i class="bi bi-clock me-1"></i>{{ paiement.date_paiement|date:"H:i" }}</small>
            </div>
          </div>
        </div>
      {% empty %}
        <div class="list-group-item text-center text-muted py-4 caisse-list-item">
          <i class="bi bi-emoji-frown fs-3 mb-2"></i><br>
          Aucun paiement enregistré aujourd'hui
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<!-- Bootstrap Icons CDN (si pas déjà inclus dans base_admin.html) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body, .container {
    background-color: #181a1b !important;
    color: #e0e0e0 !important;
  }
  .caisse-card {
    background: #23272b;
    color: #e0e0e0;
  }
  .caisse-header {
    background: #212529;
    color: #fff;
    font-weight: 500;
    font-size: 1.1rem;
    letter-spacing: 0.5px;
    border-bottom: 1px solid #343a40;
  }
  .caisse-btn {
    font-weight: 600;
    border-radius: 30px;
    transition: background 0.2s, color 0.2s;
    box-shadow: 0 2px 8px rgba(40,167,69,0.15);
  }
  .caisse-btn:hover, .caisse-btn:focus {
    background: #218838 !important;
    color: #fff !important;
  }
  .caisse-list {
    background: transparent;
  }
  .caisse-list-item {
    background: transparent;
    border: none;
    border-bottom: 1px solid #343a40;
    color: #e0e0e0;
  }
  .caisse-list-item:last-child {
    border-bottom: none;
  }
  .dark-text {
    color: #e0e0e0 !important;
  }
  .dark-muted {
    color: #b0b0b0 !important;
  }
  .badge.bg-secondary {
    background-color: #495057 !important;
    color: #e0e0e0 !important;
  }
  .badge.bg-success {
    background-color: #198754 !important;
  }
  .badge.bg-warning {
    background-color: #ffc107 !important;
    color: #23272b !important;
  }
  .badge.bg-danger {
    background-color: #dc3545 !important;
  }
  /* Scrollbar for dark mode */
  ::-webkit-scrollbar {
    width: 8px;
    background: #23272b;
  }
  ::-webkit-scrollbar-thumb {
    background: #343a40;
    border-radius: 4px;
  }
  .card-stats {
    border-radius: 15px;
    transition: transform 0.3s;
    min-height: 210px;
  }
  .card-stats:hover {
    transform: translateY(-3px) scale(1.01);
  }
  .bg-gradient-primary {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
  }
  .bg-gradient-success {
    background: linear-gradient(135deg, #28a745 0%, #218838 100%) !important;
  }
  .bg-gradient-warning {
    background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%) !important;
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Chart du jour
  new Chart(document.getElementById('chartJour').getContext('2d'), {
    type: 'line',
    data: {
      labels: {{ stats_jour.labels|safe }},
      datasets: [{
        label: 'Montant',
        data: {{ stats_jour.data|safe }},
        borderColor: '#fff',
        backgroundColor: 'rgba(255,255,255,0.2)',
        tension: 0.4,
        fill: true,
        pointRadius: 2
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { x: { display: false }, y: { display: false } },
      elements: { line: { borderWidth: 3 } },
      responsive: true
    }
  });

  // Chart semaine
  new Chart(document.getElementById('chartSemaine').getContext('2d'), {
    type: 'bar',
    data: {
      labels: {{ stats_semaine.labels|safe }},
      datasets: [{
        label: 'Montant',
        data: {{ stats_semaine.data|safe }},
        backgroundColor: '#fff',
        borderRadius: 6
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { x: { display: false }, y: { display: false } },
      responsive: true
    }
  });

  // Chart mois
  new Chart(document.getElementById('chartMois').getContext('2d'), {
    type: 'bar',
    data: {
      labels: {{ stats_mois.labels|safe }},
      datasets: [{
        label: 'Montant',
        data: {{ stats_mois.data|safe }},
        backgroundColor: '#fff',
        borderRadius: 6
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: { x: { display: false }, y: { display: false } },
      responsive: true
    }
  });

  // Statistiques mensuelles (courbe)
  new Chart(document.getElementById('monthlyStatsChart').getContext('2d'), {
    type: 'line',
    data: {
      labels: {{ monthly_labels|safe }},
      datasets: [{
        label: 'Encaissements',
        data: {{ monthly_data|safe }},
        borderColor: '#43a047',
        backgroundColor: 'rgba(67,160,71,0.15)',
        tension: 0.4,
        fill: true,
        pointRadius: 4,
        pointBackgroundColor: '#43a047'
      }]
    },
    options: {
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: { title: { display: false }, grid: { display: false } },
        y: { beginAtZero: true, ticks: { color: '#b0b0b0' } }
      },
      responsive: true
    }
  });

  // Répartition des paiements (doughnut)
  new Chart(document.getElementById('paymentDistributionChart').getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: {{ payment_types_labels|safe }},
      datasets: [{
        data: {{ payment_types_data|safe }},
        backgroundColor: ['#43a047', '#2196f3', '#ff9800'],
        borderWidth: 0
      }]
    },
    options: {
      plugins: {
        legend: {
          display: true,
          position: 'bottom',
          labels: { color: '#b0b0b0', font: { size: 14 } }
        }
      },
      cutout: '70%',
      responsive: true
    }
  });
});
</script>
{% endblock %}