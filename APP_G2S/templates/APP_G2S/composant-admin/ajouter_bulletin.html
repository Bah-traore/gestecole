{% extends 'base_admin.html' %}
{% block content %}
{% load perso_filtre %}
{% if messages %}
<div class="mb-4">
    
    
    {% for field in form %}
        {% for error in field.errors %}
            <div class="p-4 w-[500px] mx-auto text-white text-center rounded bg-red-500">
                {{ error }}
            </div>
        {% endfor %}
    {% endfor %}
    {% for error in form.non_field_errors %}
        <div class="p-4 w-[500px] mx-auto text-white text-center rounded bg-red-500">
            {{ error }}
        </div>
        {% endfor %}
</div>
{% endif %}

{% if not periode_active %}
    <div class="p-4 mb-4 text-white bg-red-500 rounded">
        ❌ Aucune période scolaire active n'est configurée. Contactez l'administrateur.
    </div>
{% endif %}
<h1 class="text-center">Données pour la période : {{ active_period.numero }} ({{ active_period.annee_scolaire }})</h1>

{% if periode_active %}
<div class="flex flex-col md:flex-row gap-6 p-4">
    <!-- Partie Gauche - Liste des élèves -->
    <div class="flex-1 bg-white shadow-md rounded-lg p-6 dark:bg-blue-900 md:max-w-[400px]">
        <div class="mb-6">
            <h3 class="text-xl font-semibold text-center mt-2 dark:bg-gray-800 rounded">Élèves de la classe</h3>
            <div class="mb-10">
                <i class="underline mb-2">choisissez la classe</i><span>*</span>
                <div id="classe-select">
                    {% csrf_token %}
                    {{ form.classes }}
                    {% if form.classe.errors %}
                    <p class="text-red-500 text-xs italic">{{ form.classe.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="mb-4">
            <input 
                type="text" 
                id="search-eleves" 
                placeholder="Rechercher un élève..." 
                class="w-full p-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-200"
            >
        </div>
        
        <div class="selected-info mt-2 p-2 bg-blue-50 rounded">
            <span id="selected-count">0</span> élève(s) sélectionné(s)
        </div>
        <!-- <div id="eleves-container" class="space-y-2 h-32 md:h-40 overflow-y-auto mt-4"> -->
            <!-- Liste des élèves par js -->
        <!-- </div> -->

        <div id="eleves-list" class="space-y-2 mt-6 dark:bg-gray-800 h-[200px] md:h-[300px] overflow-y-auto">
            <!-- Contenu des classes et élèves -->
        </div>

        <div class="mt-4 flex flex-col md:flex-row gap-2 md:justify-end">
            <button type="button" id="select-all" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                Sélectionner tout
            </button>
            <button type="button" id="deselect-all" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">
                Désélectionner
            </button>
            <button type="button" id="generate-selected" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                Générer
            </button>
        </div>
    </div>
{% endif %}

    
    <!-- Panneau droit - Bulletin -->
<div id="Bulletin" class="flex-1 row-span-2 bg-white shadow-md rounded-lg p-6 max-w-4xl mx-auto hidden">
    <!-- En-tête du bulletin -->
    <div class="lg:col-span-2 bg-white shadow-md rounded-lg p-6">
        <!-- En-tête amélioré -->
        <div class="mb-8 text-center border-b pb-4">
            <div class="mb-2">
                <img src="" alt="Logo" class="h-16 mx-auto mb-3">
            </div>
            <h2 class="text-2xl font-bold text-gray-800">LYCÉE DOWÈLE MARICO DE DIOILA</h2>
            <p class="text-sm text-gray-600 mt-1">AE : DIOILA - Année scolaire <span id="annees"></span></p>
            {% comment %} <p class="text-md text-gray-600 mt-1"><span id="annees"></span></p> {% endcomment %}
        </div>

        <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-sm">
            <div class="grid grid-cols-2 gap-4 text-sm">
                <div class="space-y-1">
                    <div class="font-medium text-gray-600">Nom complet:</div>
                    <div class="text-gray-800" id="eleve-nom"></div>
                </div>
                <div class="space-y-1">
                    <div class="font-medium text-gray-600">Classe:</div>
                    <div class="text-gray-800" id="eleve-classe"></div>
                </div>
                <div class="space-y-1">
                    <div class="font-medium text-gray-600">Contact:</div>
                    <div class="text-gray-800" id="eleve-contact"></div>
                </div>
                <div class="space-y-1">
                    <div class="font-medium text-gray-600">Résidence:</div>
                    <div class="text-gray-800" id="eleve-residence"></div>
                </div>
            </div>
        </div>

    <form method="POST" id="bulletinForm">

        <div class="mb-6 overflow-x-auto">
            <table class="w-full border-collapse border-2 border-gray-200">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="border-2 border-gray-300 p-3 text-left">Matière</th>
                        <th class="border-2 border-gray-300 p-3 text-center">Coefficient</th>
                        <th class="border-2 border-gray-300 p-3 text-center">Note_classe/20</th>
                        <th class="border-2 border-gray-300 p-3 text-center">Note_comp/40</th>
                        <th class="border-2 border-gray-300 p-3 text-center">Moyenne Coefficient</th>
                    </tr>
                </thead>

                <tbody>
       
                    <tr id="tr" class="hover:bg-gray-50" data-matiere="" data-template>

<!--affiche les donnees du bulletin a partir du js code dans bulletin_js.js-->                        
                    </tr>
                </tbody>
        
                <tr>
                    <td colspan="4" class="text-right font-bold">Moyenne Générale :</td>
                    <td class="text-center font-bold" id="moyenne-generale">
                        
                    </td>
                </tr>
                <tr>
                    <td colspan="4" class="text-right font-bold">Classement dans la classe :</td>
                    <td class="text-center font-bold"></td>
                </tr>
            </table>
        </div>

        <!-- Appréciation -->
        <div class="mb-4">
            <label class="block font-medium mb-2">Appréciation générale :</label>
            <textarea id="appreciation-generale" name="appreciation" class="w-full p-2 border rounded" readonly></textarea>
        </div>
      

        <div class="flex justify-end">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors flex items-center" id="generate-selected">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            {% csrf_token %}
            Sauvegarder le bulletin
            </button>

<!--{% comment %} -->

<!--            <a href="{% url 'generate_bulletins' %}?classe_id={{ selected_classe }}&eleve_ids={% for b in bulletins %}{{ b.eleve.id }}{% if not forloop.last %},{% endif %}{% endfor %}" -->
<!--                class="inline-flex items-center px-4 py-2 border border-red-600 text-red-600 rounded-lg hover:bg-red-50 transition shadow-sm">-->
<!--                    generer bulletin-->
<!--                </a> {% endcomment %}-->
        </div>
    </form>


</div>
<div id="loading-indicator" class="hidden fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg flex items-center">
        <div class="animate-spin mr-4">
            <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
            </svg>
        </div>
        <span class="text-gray-700">Chargement des données...</span>
    </div>
</div>



{% load static %}
<style>
    select, textarea {
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    select:focus, textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }


        .select-options {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e0 #f1f5f9;
        }

        .select-options {
    transition: all 0.3s ease;
    transform-origin: top;
}

/* Style pour les options */
#id_eleve option {
    padding: 8px 12px;
    cursor: pointer;
    transition: background-color 0.2s;
}

#id_eleve option:hover {
    background-color: #f3f4f6;
}

/* Indicateur de chargement */
#loading {
    z-index: 9999;
}



/* Style pour la liste déroulante scrollable */
#eleveDropdown {
    max-height: 300px;
    overflow-y: auto;
}

/* Style pour les options avec scrollbar personnalisé */
.select-options::-webkit-scrollbar {
    width: 8px;
}
.select-options::-webkit-scrollbar-track {
    background: #f1f5f9;
}
.select-options::-webkit-scrollbar-thumb {
    background: #cbd5e0;
    border-radius: 4px;
}


.eleve-option {
    transition: background-color 0.2s;
}

.eleve-option:hover {
    background-color: #f3f4f6;
}

#eleve-list {
    scrollbar-width: thin;
    scrollbar-color: #cbd5e0 #f1f5f9;
}
.eleve-link {
    background-color: #ff0000
}

</style>

<script src="{% static "APP_G2S/js/bulletin_js.js" %}"></script>

{% endblock %}